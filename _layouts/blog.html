---
# Copyright (c) 2018 Florian Klampfer <https://qwtel.com/>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

layout: base
---

{% assign plugins = site.plugins | default:site.gems %}

{% if plugins contains 'jekyll-paginate' %}
  {% assign posts = paginator.posts %}
{% else %}
  {% assign posts = site.categories[page.slug] | default:site.tags[page.slug] | default:site.posts %}
{% endif %}

{% assign list_entry = site.data.strings.date_formats.related_post | default:"%d %b %Y" %}
<ul class="related-posts">
  {% for post in posts %}
    {% include_cached components/post-list-item.html post=post format=list_entry %}
  {% endfor %}
</ul>

{% if plugins contains 'jekyll-paginate' %}
  {% include components/pagination.html %}
{% endif %}

<script>
  (function () {
    if (window.__homeTextIntroBound) return;
    window.__homeTextIntroBound = true;

    var INTRO_DONE = 'done';
    var INTRO_RUNNING = 'running';
    var INTRO_IDLE = 'idle';
    var INTRO_FINISH_DELAY_MS = 220;
    var DEBUG = true;

    var introLog = function (message, data) {
      if (!DEBUG || !window.console || typeof window.console.log !== 'function') return;
      if (typeof data === 'undefined') {
        window.console.log('[home-intro]', message);
        return;
      }
      window.console.log('[home-intro]', message, data);
    };

    if (!window.__homeTextIntroState) {
      window.__homeTextIntroState = INTRO_IDLE;
    }

    var isIntroDone = function () { return window.__homeTextIntroState === INTRO_DONE; };

    var markIntroDone = function () {
      window.__homeTextIntroState = INTRO_DONE;
    };

    var notifyIntroFinished = function () {
      introLog('notifyIntroFinished');
      if (typeof window.__onHomeIntroFinished === 'function') {
        try {
          window.__onHomeIntroFinished();
        } catch (err) {}
      }
      window.dispatchEvent(new CustomEvent('home-intro-finished'));
    };

    var wrapTextWithIntroChars = function (element, viewportWidth, viewportHeight) {
      var text = element.textContent || '';
      if (!text.trim()) return { count: 0, maxEnd: 0, nodes: [] };

      element.textContent = '';
      var fragment = document.createDocumentFragment();
      var maxEnd = 0;
      var nodes = [];
      var radiusBase = Math.max(viewportWidth, viewportHeight);
      var minRadius = radiusBase * 0.72;
      var maxRadius = radiusBase * 1.25;

      Array.from(text).forEach(function (char) {
        var charNode = document.createElement('span');
        charNode.className = 'text-drop-char';
        if (char === ' ') {
          charNode.className += ' space';
          charNode.textContent = ' ';
        } else {
          charNode.textContent = char;
        }

        var angle = Math.random() * Math.PI * 2;
        var radius = minRadius + Math.random() * (maxRadius - minRadius);
        var fromX = Math.cos(angle) * radius;
        var fromY = Math.sin(angle) * radius;
        var fromRotate = Math.random() * 140 - 70;
        var fromScale = 1.8 + Math.random() * 1.6;
        var delay = Math.random() * 0.52;
        var duration = 1.55 + Math.random() * 1.15;

        charNode.style.setProperty('--drop-x', fromX.toFixed(2) + 'px');
        charNode.style.setProperty('--drop-y', fromY.toFixed(2) + 'px');
        charNode.style.setProperty('--drop-r', fromRotate.toFixed(2) + 'deg');
        charNode.style.setProperty('--drop-s', fromScale.toFixed(2));
        charNode.style.setProperty('--drop-dur', duration.toFixed(3) + 's');
        charNode.style.animationDelay = delay.toFixed(3) + 's';

        maxEnd = Math.max(maxEnd, delay + duration);
        nodes.push(charNode);
        fragment.appendChild(charNode);
      });

      element.appendChild(fragment);
      return { count: nodes.length, maxEnd: maxEnd, nodes: nodes };
    };

    var runIntro = function (scope) {
      if (isIntroDone() || window.__homeTextIntroState === INTRO_DONE || window.__homeTextIntroState === INTRO_RUNNING) {
        introLog('runIntro skipped', { state: window.__homeTextIntroState });
        return;
      }

      if (!scope || !scope.querySelectorAll) return;

      var targets = scope.querySelectorAll('.related-posts .h4 > a > span, .related-posts time');
      if (!targets.length) return;
      introLog('runIntro start', { targets: targets.length });

      var reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (reduceMotion) {
        introLog('runIntro reduced-motion');
        markIntroDone();
        notifyIntroFinished();
        return;
      }

      window.__homeTextIntroState = INTRO_RUNNING;

      var viewportWidth = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0, 1024);
      var viewportHeight = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0, 768);
      var maxEnd = 0;
      var pending = 0;
      var finished = false;
      var finishTimeout = null;
      var notifyTimeout = null;

      var finishIntro = function () {
        if (finished) return;
        finished = true;
        if (finishTimeout) {
          window.clearTimeout(finishTimeout);
          finishTimeout = null;
        }
        if (notifyTimeout) {
          window.clearTimeout(notifyTimeout);
          notifyTimeout = null;
        }
        markIntroDone();
        introLog('finishIntro', { pending: pending, maxEnd: maxEnd });
        notifyTimeout = window.setTimeout(notifyIntroFinished, INTRO_FINISH_DELAY_MS);
      };

      targets.forEach(function (target) {
        var result = wrapTextWithIntroChars(target, viewportWidth, viewportHeight);
        maxEnd = Math.max(maxEnd, result.maxEnd);
        pending += result.count;

        result.nodes.forEach(function (node) {
          node.addEventListener('animationend', function () {
            pending -= 1;
            if (pending <= 0) finishIntro();
          }, { once: true });
        });
      });

      if (pending <= 0) {
        introLog('pending is 0 -> finish');
        finishIntro();
        return;
      }

      var completeAfter = Math.round((maxEnd + 1.8) * 1000);
      introLog('fallback timeout set', { ms: completeAfter, pending: pending });
      finishTimeout = window.setTimeout(finishIntro, completeAfter);
    };

    var runOnDocument = function () { runIntro(document); };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runOnDocument, { once: true });
    } else {
      runOnDocument();
    }

    var pushState = document.querySelector('hy-push-state');
    if (!pushState) return;

    pushState.addEventListener('hy-push-state-ready', function (event) {
      if (isIntroDone() || window.__homeTextIntroState !== INTRO_IDLE) return;
      var scope = event.detail && event.detail.replaceEls && event.detail.replaceEls[0];
      runIntro(scope || document);
    });
  })();
</script>
