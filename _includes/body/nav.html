<span class="sr-only">{{ site.data.strings.navigation | default:"Navigation" }}{{ site.data.strings.colon | default:":" }}</span>
<ul class="sidebar-nav-list">
  {% assign nodes = site.html_pages | concat: site.documents | where: "sidebar", true | sort: "order" %}
  {% assign has_active_menu = false %}
  {% for nav_node in nodes %}
    {% assign nav_subnodes = site.featured_categories | where: "menu_parent", nav_node.slug %}
    {% if page.url == nav_node.url %}
      {% assign has_active_menu = true %}
    {% else %}
      {% for nav_subnode in nav_subnodes %}
        {% if page.url == nav_subnode.url %}
          {% assign has_active_menu = true %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if has_active_menu %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% assign default_open_applied = false %}
  {% for node in nodes %}
    {% unless node.redirect_to %}
      {% assign subnodes = site.featured_categories | where: "menu_parent", node.slug | sort: "order" %}
      <li class="sidebar-nav-entry">
        {% if subnodes != empty %}
          {% assign submenu_open = false %}
          {% if page.url == node.url %}
            {% assign submenu_open = true %}
          {% else %}
            {% for subnode in subnodes %}
              {% if page.url == subnode.url %}
                {% assign submenu_open = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if submenu_open == false and has_active_menu == false and default_open_applied == false %}
            {% assign submenu_open = true %}
            {% assign default_open_applied = true %}
          {% endif %}
          <details class="sidebar-nav-group"{% if submenu_open %} open{% endif %}>
            <summary {% if forloop.first %}id="_navigation"{% endif %} class="sidebar-nav-summary">
              <span class="sidebar-nav-label">{{ node.title }}</span>
              <span class="sidebar-nav-caret" aria-hidden="true"></span>
            </summary>
            <ul class="sidebar-submenu">
              {% for subnode in subnodes %}
                <li>
                  <a class="sidebar-nav-subitem{% if page.url == subnode.url %} active{% endif %}" href="{{ subnode.url | relative_url }}">{{ subnode.title }}</a>
                </li>
              {% endfor %}
            </ul>
          </details>
        {% else %}
          <a {% if forloop.first %}id="_navigation"{% endif %} href="{{ node.url | relative_url }}" class="sidebar-nav-item{% if page.url == node.url %} active{% endif %}" {% if node.rel %}rel="{{ node.rel }}"{% endif %}>{{ node.title }}</a>
        {% endif %}
      </li>
    {% else %}
      <li>
        <a href="{{ node.redirect_to }}" class="sidebar-nav-item external{% if page.url == node.url %} active{% endif %}">{{ node.title }}</a>
      </li>
    {% endunless %}
  {% endfor %}
</ul>
<script>
  (function () {
    if (window.__sidebarAccordionBound) return;
    window.__sidebarAccordionBound = true;

    document.addEventListener('toggle', function (event) {
      var opened = event.target;
      if (!opened.classList || !opened.classList.contains('sidebar-nav-group')) return;
      if (!opened.open) return;

      var container = opened.closest('.sidebar-nav-list');
      if (!container) return;

      container.querySelectorAll('.sidebar-nav-group[open]').forEach(function (node) {
        if (node !== opened) node.open = false;
      });
    }, true);

    document.addEventListener('click', function (event) {
      var target = event.target;
      if (!target || !target.closest) return;

      var trigger = target.closest('.sidebar-nav-summary, .sidebar-nav-item');
      if (!trigger) return;

      trigger.classList.remove('menu-clicked');
      void trigger.offsetWidth;
      trigger.classList.add('menu-clicked');

      window.setTimeout(function () {
        trigger.classList.remove('menu-clicked');
      }, 420);
    }, true);
  })();
</script>
