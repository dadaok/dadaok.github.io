---
layout:   post
title:    "OAuth2"
subtitle: "OAuth2 í•™ìŠµ"
category: Spring
more_posts: posts.md
tags:     Spring
---
# [Spring OAuth2] Security & OAuth2

<!--more-->
<!-- Table of contents -->
* this unordered seed list will be replaced by the toc
{:toc}

<!-- text -->


# âœ… OAuth2 ë¡œê·¸ì¸ ì •ë¦¬

OAuth2ë¥¼ í™œìš©í•˜ì—¬ ë„¤ì´ë²„, ì¹´ì¹´ì˜¤, êµ¬ê¸€ ë“±ì˜ ì†Œì…œ ë¡œê·¸ì¸ì„ ì ìš©í•˜ëŠ” ë°©ì‹ê³¼ í…Œí¬ ê¸°ì—…ë“¤ì´ ì„ í˜¸í•˜ëŠ” ì²˜ë¦¬ ë°©ë²•ì„ ì •ë¦¬í•œë‹¤. íŠ¹íˆ, API Gatewayë¥¼ í†µê³¼í•˜ëŠ” êµ¬ì¡°ë¥¼ ê³ ë ¤í•˜ì—¬ ìµœì ì˜ êµ¬í˜„ ë°©ì‹ì„ ì„¤ëª…í•œë‹¤.

---

## ğŸ”¹ 1. OAuth2 ë¡œê·¸ì¸ íë¦„
OAuth2 ë¡œê·¸ì¸ì€ **ê¶Œí•œ ì½”ë“œ(Authorization Code) í”Œë¡œìš°**ë¥¼ ë”°ë¥¸ë‹¤.

### ğŸ“Œ OAuth2 ë¡œê·¸ì¸ ê³¼ì •
1ï¸âƒ£ ì‚¬ìš©ìê°€ `/oauth2/authorization/naver`ë¡œ ë¡œê·¸ì¸ ìš”ì²­
2ï¸âƒ£ Spring Securityê°€ ë„¤ì´ë²„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰íŠ¸
3ï¸âƒ£ ì‚¬ìš©ìê°€ ë„¤ì´ë²„ ë¡œê·¸ì¸ ì™„ë£Œ â†’ `Authorization Code`ë¥¼ ì„œë²„ë¡œ ë°˜í™˜
4ï¸âƒ£ ì„œë²„ê°€ ë„¤ì´ë²„ì— `Authorization Code`ë¥¼ ë³´ë‚´ê³ , `Access Token`ì„ ìš”ì²­
5ï¸âƒ£ ë„¤ì´ë²„ì—ì„œ `Access Token`ê³¼ í•¨ê»˜ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜
6ï¸âƒ£ ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ DBì— ì €ì¥í•˜ê±°ë‚˜ JWT ë°œê¸‰ í›„ ì‘ë‹µ

---

## ğŸ”¹ 2. Spring Security ì„¤ì •
### ğŸ“Œ `application.yml` ì„¤ì •
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          naver:
            client-id: YOUR_CLIENT_ID
            client-secret: YOUR_CLIENT_SECRET
            redirect-uri: "http://localhost:8081/oauth2/callback/naver"
            client-name: Naver
            authorization-grant-type: authorization_code
            scope:
              - name
              - gender
              - mobile
          kakao:
            client-id:
            client-secret:
            redirect-uri:
            client-name: Kakao
            authorization-grant-type: authorization_code
            client-authentication-method: client_secret_post
            scope:
                - profile_nickname
          google:
            client-id:
            client-secret:
            scope:
              - email
              - profile
        provider: # kakao, naverë§Œ ì¶”ê°€ë¡œ ì‘ì„±
          kakao:
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
            user-info-uri: https://kapi.kakao.com/v2/user/me
            user-name-attribute: id
          naver:
            authorization_uri: https://nid.naver.com/oauth2.0/authorize
            token_uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user_name_attribute: response
```

---

### ğŸ“Œ SecurityConfig ì„¤ì • (`SecurityFilterChain`)
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/oauth2/**", "/login/**").permitAll()
            .anyRequest().authenticated()
        )
        // .authorizeHttpRequests(auth -> auth.anyRequest().permitAll()) ì „ì²´ í—ˆìš©
        .csrf(AbstractHttpConfigurer::disable)
        .formLogin(AbstractHttpConfigurer::disable)
        .oauth2Login(oauth2 -> oauth2
            .userInfoEndpoint(userInfoEndpointConfig ->
                userInfoEndpointConfig.userService(customOAuth2UserService)
            )
            .successHandler(oAuth2LoginSuccessHandler)
        );

    return http.build();
}
```

---

## ğŸ”¹ 3. OAuth2 ì‚¬ìš©ì ì •ë³´ ì²˜ë¦¬ ë°©ì‹
OAuth2 ë¡œê·¸ì¸ í›„ ì‚¬ìš©ì ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì€ ë‘ ê°€ì§€ê°€ ìˆë‹¤.

### âœ… 1. `userInfoEndpoint()` ë°©ì‹ (Spring Security ìë™ ì²˜ë¦¬)
- Spring Securityê°€ `UserInfo API`ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜´.
- Provider(ë„¤ì´ë²„, ì¹´ì¹´ì˜¤, êµ¬ê¸€)ë³„ë¡œ ë‹¤ë¥¸ í•„ë“œëª…ì„ í‘œì¤€í™”í•  ìˆ˜ ìˆìŒ.

```java
@Service
public class CustomOAuth2UserService extends DefaultOAuth2UserService {
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2User oAuth2User = super.loadUser(userRequest);

        String provider = userRequest.getClientRegistration().getRegistrationId();
        String email = oAuth2User.getAttribute("email");
        String name = oAuth2User.getAttribute("name");

        return new DefaultOAuth2User(
                Collections.singleton(new SimpleGrantedAuthority("ROLE_USER")),
                Map.of("provider", provider, "email", email, "name", name),
                "email"
        );
    }
}
```

### âœ… 2. `successHandler()` ë°©ì‹ (ë¡œê·¸ì¸ ì„±ê³µ í›„ ì§ì ‘ ì²˜ë¦¬)
- ë¡œê·¸ì¸ ì„±ê³µ í›„ JWTë¥¼ ë°œê¸‰í•˜ê³  ì‘ë‹µ
- API Gatewayë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ìœ ìš©í•¨

```java
@Component
public class OAuth2LoginSuccessHandler extends SimpleUrlAuthenticationSuccessHandler {

    private final TokenService tokenService;
    
    public OAuth2LoginSuccessHandler(TokenService tokenService) {
        this.tokenService = tokenService;
    }

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
                                        Authentication authentication) throws IOException {
        OAuth2User oAuth2User = (OAuth2User) authentication.getPrincipal();

        String email = oAuth2User.getAttribute("email");
        String name = oAuth2User.getAttribute("name");
        String provider = oAuth2User.getAttribute("provider");

        String accessToken = tokenService.generateToken(email);

        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");
        response.getWriter().write("{"accessToken": \"" + accessToken + "\", \"email\": \"" + email + "\", \"name\": \"" + name + "\", \"provider\": \"" + provider + "\"}");
    }
}
```

---

## ğŸ”¹ 4. API Gatewayë¥¼ í†µê³¼í•˜ëŠ” OAuth2 ì¸ì¦ ì²˜ë¦¬
API Gatewayë¥¼ ì‚¬ìš©í•  ê²½ìš°, í´ë¼ì´ì–¸íŠ¸ëŠ” **JWTë¥¼ ë°›ì•„ì„œ API ìš”ì²­ ì‹œ ì‚¬ìš©í•´ì•¼ í•¨**.

ğŸ“Œ **API Gatewayì—ì„œ JWTë¥¼ ê²€ì¦í•˜ëŠ” ë°©ì‹**
1ï¸âƒ£ ì‚¬ìš©ìê°€ `/oauth2/authorization/naver`ë¡œ ë¡œê·¸ì¸ ìš”ì²­
2ï¸âƒ£ OAuth2 ë¡œê·¸ì¸ í›„ `successHandler()`ì—ì„œ JWT ë°œê¸‰
3ï¸âƒ£ í´ë¼ì´ì–¸íŠ¸ê°€ JWTë¥¼ `Authorization` í—¤ë”ì— í¬í•¨í•˜ì—¬ API ìš”ì²­
4ï¸âƒ£ API GatewayëŠ” JWTë¥¼ ê²€ì¦í•˜ì—¬ ìœ íš¨í•œ ìš”ì²­ë§Œ Backend ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬

ğŸ“Œ **OAuth2 ë¡œê·¸ì¸ í›„ ì‘ë‹µ ì˜ˆì œ**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI...",
  "email": "user@example.com",
  "name": "í™ê¸¸ë™",
  "provider": "naver"
}
```

ğŸ“Œ **í´ë¼ì´ì–¸íŠ¸ì—ì„œ API ìš”ì²­ ì‹œ JWT ì‚¬ìš©**
```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI...
```

---

## ğŸ”¹ 5. `userInfoEndpoint()` + `successHandler()` ì¡°í•© ë°©ì‹ì˜ ì¥ì 
| ê¸°ëŠ¥ | `userInfoEndpoint()` | `successHandler()` |
|------|---------------------|-------------------|
| OAuth2 ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° | âœ… ìë™ í˜¸ì¶œ | âŒ ì§ì ‘ í˜¸ì¶œ í•„ìš” |
| OAuth2 Provider í‘œì¤€í™” | âœ… Providerë³„ í•„ë“œ í†µí•© ê°€ëŠ¥ | âŒ ì§ì ‘ ë§¤í•‘ í•„ìš” |
| JWT ë°œê¸‰ | âŒ ë³„ë„ êµ¬í˜„ í•„ìš” | âœ… JWT ë°œê¸‰ ê°€ëŠ¥ |
| API Gateway ì§€ì› | âŒ ê¸°ë³¸ ì§€ì› X | âœ… JWT ê¸°ë°˜ ì¸ì¦ ê°€ëŠ¥ |
| ë¡œê·¸ì¸ ì„±ê³µ í›„ ì¶”ê°€ ì²˜ë¦¬ | âŒ ì¶”ê°€ ë¡œì§ ì ìš© ì–´ë ¤ì›€ | âœ… DB ì €ì¥, ë¦¬ë””ë ‰ì…˜ ê°€ëŠ¥ |

---

## ğŸ¯ ìµœì¢… ì •ë¦¬
âœ” OAuth2 ë¡œê·¸ì¸ í›„ `userInfoEndpoint()`ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³ , `successHandler()`ì—ì„œ JWT ë°œê¸‰ ë° ì¶”ê°€ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì´ ì¼ë°˜ì 
âœ” API Gatewayë¥¼ ì‚¬ìš©í•  ê²½ìš° `successHandler()`ì—ì„œ JWTë¥¼ ë°œê¸‰í•˜ê³ , Backend ì„œë¹„ìŠ¤ëŠ” JWT ê²€ì¦ë§Œ ìˆ˜í–‰
âœ” MSA í™˜ê²½ì—ì„œëŠ” `userInfoEndpoint()` + `successHandler()` ì¡°í•©ì„ í†µí•´ ì¸ì¦ì„ ìµœì í™”í•  ìˆ˜ ìˆìŒ

ğŸš€ ì¦‰, í…Œí¬ ê¸°ì—…ë“¤ì€ API Gateway + JWT ì¡°í•©ì„ í†µí•´ OAuth2 ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ê²½ìš°ê°€ ë§ê³ , `userInfoEndpoint()`ë¥¼ í™œìš©í•˜ì—¬ í‘œì¤€í™”í•œ í›„ `successHandler()`ì—ì„œ ì¶”ê°€ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë°©ì‹ì„ ì„ í˜¸í•¨!

