---
layout:   post
title:    "Security"
subtitle: "Security í•™ìŠµ"
category: Spring
more_posts: posts.md
tags:     Spring
---
# [Spring Security] Security & JWT

<!--more-->
<!-- Table of contents -->
* this unordered seed list will be replaced by the toc
{:toc}

<!-- text -->


# **âœ… Spring Security + JWT + CORS + XSS ë°©ì–´ ì „ì²´ ì½”ë“œ**

MSA í™˜ê²½ì—ì„œ **JWT ì¸ì¦, CORS ì„¤ì •, XSS ë°©ì–´**ë¥¼ ëª¨ë‘ í¬í•¨í•œ **ì™„ì „í•œ Spring Security ì„¤ì •**ì„ ì œê³µí•©ë‹ˆë‹¤.  
ì´ì œ **ëª¨ë“  ìš”ì²­ì—ì„œ JWT ê²€ì¦, CORS ì²˜ë¦¬, XSS ë³´í˜¸ë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** âœ…  

---

## **1. `pom.xml` (í•„ìš”í•œ ì˜ì¡´ì„± ì¶”ê°€)**
```xml
<dependencies>
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>

    <!-- JWT (io.jsonwebtoken) -->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artifactId>
        <version>0.11.5</version>
    </dependency>

    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <scope>provided</scope>
    </dependency>
</dependencies>
```
ğŸ“Œ **Spring Security + JWT + Lombok í¬í•¨.**

---

## **2. JWT ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ (`JwtUtil.java`)**
```java
import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import java.util.Date;
import java.util.List;
import javax.crypto.SecretKey;

public class JwtUtil {

    private static final String SECRET_KEY = "mysecretkeymysecretkeymysecretkeymysecretkey"; // 32ë°”ì´íŠ¸ ì´ìƒ í•„ìš”
    private static final long EXPIRATION_TIME = 1000 * 60 * 60; // 1ì‹œê°„

    private static final SecretKey key = Keys.hmacShaKeyFor(SECRET_KEY.getBytes());

    // âœ… JWT ìƒì„± (ê¶Œí•œ ì •ë³´ í¬í•¨)
    public static String generateToken(String username, List<String> roles) {
        return Jwts.builder()
                .setSubject(username)
                .claim("roles", roles) // âœ… ê¶Œí•œ ì •ë³´ ì¶”ê°€
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(key, SignatureAlgorithm.HS256)
                .compact();
    }

    // âœ… JWTì—ì„œ ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    public static String getUsername(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody()
                .getSubject();
    }

    // âœ… JWTì—ì„œ ê¶Œí•œ(Role) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    public static List<String> getRoles(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody()
                .get("roles", List.class);
    }
}
```

---

## **3. XSS ë°©ì–´ í•„í„° (`XssFilter.java`)**
```java
import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;

public class XssFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        XssRequestWrapper wrappedRequest = new XssRequestWrapper((HttpServletRequest) request);
        chain.doFilter(wrappedRequest, response);
    }
}
```

---

## **4. XSS í•„í„°ë¥¼ ìœ„í•œ `HttpServletRequestWrapper` (`XssRequestWrapper.java`)**
```java
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletRequestWrapper;

public class XssRequestWrapper extends HttpServletRequestWrapper {

    public XssRequestWrapper(HttpServletRequest request) {
        super(request);
    }

    @Override
    public String getParameter(String name) {
        return sanitize(super.getParameter(name));
    }

    @Override
    public String[] getParameterValues(String name) {
        String[] values = super.getParameterValues(name);
        if (values == null) return null;

        for (int i = 0; i < values.length; i++) {
            values[i] = sanitize(values[i]);
        }
        return values;
    }

    private String sanitize(String input) {
        return input == null ? null : input.replaceAll("<", "&lt;")
                                           .replaceAll(">", "&gt;")
                                           .replaceAll("\"", "&quot;")
                                           .replaceAll("'", "&#x27;")
                                           .replaceAll("&", "&amp;");
    }
}
```

---

## **5. JWT ì¸ì¦ í•„í„° (`JwtAuthenticationFilter.java`)**
```java
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.User;
import org.springframework.web.filter.OncePerRequestFilter;
import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;
import java.util.stream.Collectors;

public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        String token = request.getHeader("Authorization");

        if (token != null && token.startsWith("Bearer ")) {
            try {
                String username = JwtUtil.getUsername(token.substring(7));
                List<String> roles = JwtUtil.getRoles(token.substring(7));

                List<SimpleGrantedAuthority> authorities = roles.stream()
                        .map(SimpleGrantedAuthority::new)
                        .collect(Collectors.toList());

                User user = new User(username, "", authorities);
                SecurityContextHolder.getContext().setAuthentication(new JwtAuthenticationToken(user));

            } catch (Exception e) {
                response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Invalid Token");
                return;
            }
        }
        
        filterChain.doFilter(request, response);
    }
}
```

---

## **6. Spring Security ì„¤ì • (`SecurityConfig.java`)**
```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.List;

@Configuration
public class SecurityConfig {

    private final JwtConfirmFilter jwtConfirmFilter;
    public SecurityConfig(JwtConfirmFilter jwtConfirmFilter) {
        this.jwtConfirmFilter = jwtConfirmFilter;
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            .csrf().disable()
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/auth/login").permitAll()
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .requestMatchers("/user/**").hasAnyRole("USER", "ADMIN")
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtConfirmFilter, UsernamePasswordAuthenticationFilter.class)
            .addFilterBefore(new XssFilter(), JwtConfirmFilter.class)
            .formLogin().disable();

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();

        configuration.setAllowedOriginPatterns(List.of(
            "https://example.com",
            "https://*.example.com",
            "https://anotherdomain.com"
        ));

        configuration.addAllowedMethod("*");
        configuration.addAllowedHeader("*");
        configuration.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

---

## **ğŸ”¥ ìµœì¢… ì •ë¦¬**
âœ… **JWT ì¸ì¦ í•„í„° (`JwtAuthenticationFilter`) ì ìš©**  
âœ… **XSS ë°©ì–´ í•„í„° (`XssFilter`) ì ìš©**  
âœ… **CORS ì„¤ì • (`corsConfigurationSource()`) ì ìš©**  
âœ… **Spring Securityì—ì„œ `authorizeHttpRequests()`ë¥¼ ì‚¬ìš©í•œ ê¶Œí•œ ê´€ë¦¬ ì ìš©**

---

### **âœ… Spring Securityì˜ `SecurityFilterChain`ì—ì„œ ê¶Œí•œ(Role) ì •ë³´ëŠ” ì–´ë–»ê²Œ ì „ë‹¬ë ê¹Œ?**
Spring Securityì—ì„œ **ì‚¬ìš©ìì˜ ê¶Œí•œ(Role) ì •ë³´ëŠ” `Authentication` ê°ì²´ë¥¼ í†µí•´ ê´€ë¦¬ë˜ë©°, SecurityContextì— ì €ì¥ë¨**.  
ì´ ê¶Œí•œ ì •ë³´ëŠ” **JWT í† í° ê¸°ë°˜ ì¸ì¦ì„ ì‚¬ìš©í•  ê²½ìš°, JWTì—ì„œ ì¶”ì¶œí•˜ì—¬ SecurityContextì— ì €ì¥**í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.

---

## **1. `SecurityFilterChain`ì—ì„œ ê¶Œí•œ ì •ë³´ê°€ ì²˜ë¦¬ë˜ëŠ” íë¦„**
```
[í´ë¼ì´ì–¸íŠ¸ ìš”ì²­] 
    â†’ SecurityFilterChain ì‹œì‘
        â†’ JwtAuthenticationFilter ì‹¤í–‰ (JWTì—ì„œ ê¶Œí•œ ì •ë³´ ì¶”ì¶œ)
        â†’ SecurityContextHolderì— Authentication ì €ì¥
        â†’ SecurityContextPersistenceFilter (SecurityContext ìœ ì§€)
        â†’ AuthorizationFilter (ê¶Œí•œ ê²€ì‚¬)
    â†’ ì»¨íŠ¸ë¡¤ëŸ¬ ì‹¤í–‰
    â†’ ì‘ë‹µ ë°˜í™˜
[í´ë¼ì´ì–¸íŠ¸ ì‘ë‹µ ë°›ìŒ]
```
âœ… **JWT ê¸°ë°˜ ì¸ì¦ì„ ì‚¬ìš©í•  ê²½ìš°, `JwtAuthenticationFilter`ì—ì„œ JWTì—ì„œ ê¶Œí•œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ `SecurityContext`ì— ì €ì¥**.  
âœ… **ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ `@PreAuthorize`, `SecurityContextHolder` ë“±ì„ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œ ê¸°ë°˜ ë¶„ê¸° ì²˜ë¦¬ ê°€ëŠ¥**.

---

## **2. `JwtAuthenticationFilter`ì—ì„œ ê¶Œí•œ ì •ë³´ë¥¼ SecurityContextì— ì €ì¥í•˜ëŠ” ë°©ë²•**
### âœ… **JWTì—ì„œ ê¶Œí•œ(Role) ì •ë³´ ì¶”ì¶œ ë° SecurityContext ì €ì¥**
```java
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.User;
import org.springframework.web.filter.OncePerRequestFilter;
import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        String token = request.getHeader("Authorization");

        if (token != null && token.startsWith("Bearer ")) {
            try {
                String username = JwtUtil.getUsername(token.substring(7)); // âœ… ì‚¬ìš©ì ì´ë¦„ ì¶”ì¶œ
                List<String> roles = JwtUtil.getRoles(token.substring(7)); // âœ… JWTì—ì„œ ì—­í• (Role) ì¶”ì¶œ

                // âœ… ì—­í•  ì •ë³´ë¥¼ SecurityContextì— ì €ì¥ roleì€ new SimpleGrantedAuthority("ROLE_"+claims.get("role")) í˜•íƒœë¡œ ë“¤ì–´ê°€ì•¼ ëœë‹¤.
                List<SimpleGrantedAuthority> authorities = roles.stream()
                        .map(SimpleGrantedAuthority::new)
                        .collect(Collectors.toList());

                User user = new User(username, "", authorities);
                UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = new UsernamePasswordAuthenticationToken(user, null, authorities);
                SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);

            } catch (Exception e) {
                response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Invalid Token");
                return;
            }
        }
        
        filterChain.doFilter(request, response);
    }
}
```
ğŸ“Œ **JWTì—ì„œ `getRoles()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê³ , SecurityContextì— ì €ì¥**.  
ğŸ“Œ **ì¶”ì¶œëœ ê¶Œí•œ ì •ë³´ë¥¼ `SimpleGrantedAuthority`ë¡œ ë³€í™˜í•˜ì—¬ Spring Securityì˜ ê¶Œí•œ ì‹œìŠ¤í…œì— ë§ê²Œ ì ìš©**.

---

## **3. JWTì—ì„œ ê¶Œí•œ ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ” ë°©ë²• (`JwtUtil.java`)**
JWT ìƒì„± ì‹œ **ì‚¬ìš©ìì˜ ì—­í• (Role) ì •ë³´ë¥¼ `claim`ì— ì¶”ê°€**í•´ì•¼ í•©ë‹ˆë‹¤.

### âœ… **JWT ìƒì„± ì‹œ ì—­í• (Role) ì •ë³´ í¬í•¨**
```java
import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;
import javax.crypto.SecretKey;

public class JwtUtil {

    private static final String SECRET_KEY = "mysecretkeymysecretkeymysecretkeymysecretkey"; // 32ë°”ì´íŠ¸ ì´ìƒ í•„ìš”
    private static final long EXPIRATION_TIME = 1000 * 60 * 60; // 1ì‹œê°„

    private static final SecretKey key = Keys.hmacShaKeyFor(SECRET_KEY.getBytes());

    // âœ… JWT ìƒì„± (ê¶Œí•œ ì •ë³´ í¬í•¨)
    public static String generateToken(String username, List<String> roles) {
        return Jwts.builder()
                .setSubject(username)
                .claim("roles", roles) // âœ… ê¶Œí•œ ì •ë³´ ì¶”ê°€
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(key, SignatureAlgorithm.HS256)
                .compact();
    }

    // âœ… JWTì—ì„œ ì‚¬ìš©ì ì—­í• (Role) ì •ë³´ ì¶”ì¶œ
    public static List<String> getRoles(String token) {
        Claims claims = Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody();

        return claims.get("roles", List.class);
    }
}
```
ğŸ“Œ **JWT ìƒì„± ì‹œ `"roles"` í´ë ˆì„ì— ì—­í• (Role) ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ì €ì¥**.  
ğŸ“Œ **JWTì—ì„œ ì—­í•  ì •ë³´ë¥¼ `getRoles()` ë©”ì„œë“œë¥¼ í†µí•´ ì¶”ì¶œ ê°€ëŠ¥**.

---

## **4. Spring Securityì—ì„œ ê¶Œí•œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´**
### âœ… **SecurityFilterChainì—ì„œ ê¶Œí•œë³„ ì ‘ê·¼ ì œí•œ**
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .cors(cors -> cors.configurationSource(corsConfigurationSource()))
        .csrf().disable()
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/admin/**").hasRole("ADMIN") // âœ… ADMIN ê¶Œí•œ í•„ìš”
            .requestMatchers("/user/**").hasAnyRole("USER", "ADMIN") // âœ… USER ë˜ëŠ” ADMIN ê°€ëŠ¥
            .requestMatchers("/public/**").permitAll() // âœ… ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥
            .anyRequest().authenticated()
        )
        .formLogin().disable();

    return http.build();
}
```
ğŸ“Œ **SecurityFilterChainì—ì„œ `hasRole("ADMIN")`ì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • URLì— ëŒ€í•œ ì ‘ê·¼ì„ ì œí•œ**.  
ğŸ“Œ **JWTì—ì„œ ì¶”ì¶œí•œ ê¶Œí•œ ì •ë³´ë¥¼ SecurityContextì— ì €ì¥í•˜ë©´ Spring Securityì—ì„œ ìë™ìœ¼ë¡œ ê²€ì¦ ê°€ëŠ¥**.

---

## **5. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ê¶Œí•œ ê¸°ë°˜ ë¶„ê¸° ì²˜ë¦¬**
### âœ… **`@PreAuthorize`ë¥¼ í™œìš©í•œ ê¶Œí•œ ê²€ì¦**
```java
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api")
public class RoleController {

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/admin")
    public String adminAccess() {
        return "Welcome, Admin!";
    }

    @PreAuthorize("hasAnyRole('USER', 'ADMIN')")
    @GetMapping("/user")
    public String userAccess() {
        return "Welcome, User!";
    }

    @PreAuthorize("isAuthenticated()")
    @GetMapping("/profile")
    public String profile() {
        return "This is your profile.";
    }
}
```
ğŸ“Œ **JWTì—ì„œ ì¶”ì¶œí•œ ê¶Œí•œ ì •ë³´ê°€ `SecurityContext`ì— ì €ì¥ë˜ë¯€ë¡œ, `@PreAuthorize`ë¥¼ í†µí•´ ê¶Œí•œ ê²€ì¦ ê°€ëŠ¥**.  
ğŸ“Œ **`hasRole('ADMIN')`ì„ ì‚¬ìš©í•˜ì—¬ `ROLE_ADMIN`ì„ ê°€ì§„ ì‚¬ìš©ìë§Œ ì‹¤í–‰ ê°€ëŠ¥**.

---

## **6. SecurityContextì—ì„œ ì§ì ‘ ê¶Œí•œ ì •ë³´ í™•ì¸**
### âœ… **SecurityContextì—ì„œ í˜„ì¬ ì‚¬ìš©ì ê¶Œí•œ í™•ì¸**
```java
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api")
public class SecurityContextController {

    @GetMapping("/dashboard")
    public String getDashboard() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

        if (authentication.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_ADMIN"))) {
            return "Admin Dashboard";
        }

        if (authentication.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_USER"))) {
            return "User Dashboard";
        }

        return "Access Denied";
    }
}
```
ğŸ“Œ **SecurityContextì—ì„œ í˜„ì¬ ì‚¬ìš©ìì˜ ê¶Œí•œì„ ê°€ì ¸ì™€ ì§ì ‘ í™•ì¸ í›„ ë¶„ê¸° ì²˜ë¦¬ ê°€ëŠ¥**.

---

## **ğŸ”¥ ìµœì¢… ì •ë¦¬**
âœ… **JWT ìƒì„± ì‹œ ê¶Œí•œ(Role) ì •ë³´ë¥¼ `claim`ì— í¬í•¨í•˜ì—¬ ì €ì¥**  
âœ… **`JwtAuthenticationFilter`ì—ì„œ JWTì—ì„œ ê¶Œí•œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ SecurityContextì— ì €ì¥**  
âœ… **SecurityFilterChainì—ì„œ `authorizeHttpRequests()`ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´**  
âœ… **ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œëŠ” `@PreAuthorize` ë˜ëŠ” `SecurityContextHolder`ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œ ê¸°ë°˜ ë¶„ê¸° ì²˜ë¦¬ ê°€ëŠ¥**

ğŸš€ **ì¦‰, Spring Securityì˜ `SecurityFilterChain`ì—ì„œëŠ” `JwtAuthenticationFilter`ë¥¼ í†µí•´ ê¶Œí•œì„ SecurityContextì— ì „ë‹¬í•˜ê³ , ì´í›„ Spring Securityê°€ ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê¶Œí•œ ê²€ì¦ì„ ìˆ˜í–‰í•¨!** ğŸ¯