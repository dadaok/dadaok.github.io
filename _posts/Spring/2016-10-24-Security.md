---
layout:   post
title:    "Security"
subtitle: "Security í•™ìŠµ"
category: Spring
more_posts: posts.md
tags:     Spring
---
# [Spring Security] Security & JWT

<!--more-->
<!-- Table of contents -->
* this unordered seed list will be replaced by the toc
{:toc}

<!-- text -->


# **âœ… Spring Security + JWT + CORS + XSS ë°©ì–´ ì „ì²´ ì½”ë“œ**

MSA í™˜ê²½ì—ì„œ **JWT ì¸ì¦, CORS ì„¤ì •, XSS ë°©ì–´**ë¥¼ ëª¨ë‘ í¬í•¨í•œ **ì™„ì „í•œ Spring Security ì„¤ì •**ì„ ì œê³µí•©ë‹ˆë‹¤.  
ì´ì œ **ëª¨ë“  ìš”ì²­ì—ì„œ JWT ê²€ì¦, CORS ì²˜ë¦¬, XSS ë³´í˜¸ë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** âœ…  

---

## **1. `pom.xml` (í•„ìš”í•œ ì˜ì¡´ì„± ì¶”ê°€)**
```xml
<dependencies>
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>

    <!-- JWT (io.jsonwebtoken) -->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artifactId>
        <version>0.11.5</version>
    </dependency>

    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <scope>provided</scope>
    </dependency>
</dependencies>
```
ğŸ“Œ **Spring Security + JWT + Lombok í¬í•¨.**

---

## **2. JWT ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ (`JwtUtil.java`)**
```java
import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import java.util.Date;
import java.util.List;
import javax.crypto.SecretKey;

public class JwtUtil {

    private static final String SECRET_KEY = "mysecretkeymysecretkeymysecretkeymysecretkey"; // 32ë°”ì´íŠ¸ ì´ìƒ í•„ìš”
    private static final long EXPIRATION_TIME = 1000 * 60 * 60; // 1ì‹œê°„

    private static final SecretKey key = Keys.hmacShaKeyFor(SECRET_KEY.getBytes());

    // âœ… JWT ìƒì„± (ê¶Œí•œ ì •ë³´ í¬í•¨)
    public static String generateToken(String username, List<String> roles) {
        return Jwts.builder()
                .setSubject(username)
                .claim("roles", roles) // âœ… ê¶Œí•œ ì •ë³´ ì¶”ê°€
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(key, SignatureAlgorithm.HS256)
                .compact();
    }

    // âœ… JWTì—ì„œ ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    public static String getUsername(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody()
                .getSubject();
    }

    // âœ… JWTì—ì„œ ê¶Œí•œ(Role) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    public static List<String> getRoles(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody()
                .get("roles", List.class);
    }
}
```

---

## **3. XSS ë°©ì–´ í•„í„° (`XssFilter.java`)**
```java
import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;

public class XssFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        XssRequestWrapper wrappedRequest = new XssRequestWrapper((HttpServletRequest) request);
        chain.doFilter(wrappedRequest, response);
    }
}
```

---

## **4. XSS í•„í„°ë¥¼ ìœ„í•œ `HttpServletRequestWrapper` (`XssRequestWrapper.java`)**
```java
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletRequestWrapper;

public class XssRequestWrapper extends HttpServletRequestWrapper {

    public XssRequestWrapper(HttpServletRequest request) {
        super(request);
    }

    @Override
    public String getParameter(String name) {
        return sanitize(super.getParameter(name));
    }

    @Override
    public String[] getParameterValues(String name) {
        String[] values = super.getParameterValues(name);
        if (values == null) return null;

        for (int i = 0; i < values.length; i++) {
            values[i] = sanitize(values[i]);
        }
        return values;
    }

    private String sanitize(String input) {
        return input == null ? null : input.replaceAll("<", "&lt;")
                                           .replaceAll(">", "&gt;")
                                           .replaceAll("\"", "&quot;")
                                           .replaceAll("'", "&#x27;")
                                           .replaceAll("&", "&amp;");
    }
}
```

---

## **5. JWT ì¸ì¦ í•„í„° (`JwtAuthenticationFilter.java`)**
```java
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.User;
import org.springframework.web.filter.OncePerRequestFilter;
import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;
import java.util.stream.Collectors;

public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        String token = request.getHeader("Authorization");

        if (token != null && token.startsWith("Bearer ")) {
            try {
                String username = JwtUtil.getUsername(token.substring(7));
                List<String> roles = JwtUtil.getRoles(token.substring(7));

                List<SimpleGrantedAuthority> authorities = roles.stream()
                        .map(SimpleGrantedAuthority::new)
                        .collect(Collectors.toList());

                User user = new User(username, "", authorities);
                SecurityContextHolder.getContext().setAuthentication(new JwtAuthenticationToken(user));

            } catch (Exception e) {
                response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Invalid Token");
                return;
            }
        }
        
        filterChain.doFilter(request, response);
    }
}
```

---

## **6. Spring Security ì„¤ì • (`SecurityConfig.java`)**
```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.List;

@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            .csrf().disable()
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/auth/login").permitAll()
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .requestMatchers("/user/**").hasAnyRole("USER", "ADMIN")
                .anyRequest().authenticated()
            )
            .addFilterBefore(new JwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class)
            .addFilterBefore(new XssFilter(), JwtAuthenticationFilter.class)
            .formLogin().disable();

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();

        configuration.setAllowedOriginPatterns(List.of(
            "https://example.com",
            "https://*.example.com",
            "https://anotherdomain.com"
        ));

        configuration.addAllowedMethod("*");
        configuration.addAllowedHeader("*");
        configuration.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

---

## **ğŸ”¥ ìµœì¢… ì •ë¦¬**
âœ… **JWT ì¸ì¦ í•„í„° (`JwtAuthenticationFilter`) ì ìš©**  
âœ… **XSS ë°©ì–´ í•„í„° (`XssFilter`) ì ìš©**  
âœ… **CORS ì„¤ì • (`corsConfigurationSource()`) ì ìš©**  
âœ… **Spring Securityì—ì„œ `authorizeHttpRequests()`ë¥¼ ì‚¬ìš©í•œ ê¶Œí•œ ê´€ë¦¬ ì ìš©**

---

# ê¶Œí•œ ë¶„ê¸°ì²˜ë¦¬
> ê¶Œí•œ ë¶„ê¸°ì²˜ë¦¬ì˜ ë°©ë²•ìœ¼ë¡œ 3ê°€ì§€ ë°©ë²•ì„ ì†Œê°œ í•œë‹¤.  


